<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Victor - Dashboard</title>
  <link rel="icon" href="/failsafe-icon.png">
  <style>${window.VictorApp?.css || ''}</style>
</head>
<body>
  <div id="login-screen" style="display:none;">
    <div class="login-box">
      <div class="login-avatar">V</div>
      <div class="login-title">Victor</div>
      <div class="login-subtitle">Executive Ally</div>
      <input type="password" id="password-input" class="login-input" placeholder="Enter password" autofocus>
      <button class="login-btn" onclick="authenticate()">Access</button>
    </div>
  </div>
  
  <div id="app-container">
    <nav class="victor-nav">
      <div class="nav-brand">
        <div class="nav-avatar">V</div>
        <span class="nav-title">Victor</span>
      </div>
      <div class="nav-links">
        <a href="index.html" class="nav-link active"><span class="nav-icon">âŒ‚</span><span class="nav-label">Dashboard</span></a>
        <a href="emails.html" class="nav-link"><span class="nav-icon">âœ‰</span><span class="nav-label">Emails</span></a>
        <a href="calendar.html" class="nav-link"><span class="nav-icon">ðŸ“…</span><span class="nav-label">Calendar</span></a>
        <a href="tasks.html" class="nav-link"><span class="nav-icon">â˜‘</span><span class="nav-label">Tasks</span></a>
        <a href="victor.html" class="nav-link"><span class="nav-icon">ðŸ’¬</span><span class="nav-label">Chat</span></a>
        <a href="victor-dashboard.html" class="nav-link"><span class="nav-icon">âš™</span><span class="nav-label">Config</span></a>
      </div>
      <button class="nav-logout" onclick="logout()">Logout</button>
    </nav>
    
    <div class="app-content">
      <h1 style="margin-bottom: 24px;">Command Center</h1>
      
      <div class="grid grid-4" id="stats-grid">
        <div class="card">
          <div style="font-size: 32px; margin-bottom: 8px;">âœ‰</div>
          <div style="font-size: 24px; font-weight: bold;" id="email-count">-</div>
          <div style="color: #7a8fb8; font-size: 14px;">Unread Emails</div>
        </div>
        <div class="card">
          <div style="font-size: 32px; margin-bottom: 8px;">ðŸ“…</div>
          <div style="font-size: 24px; font-weight: bold;" id="event-count">-</div>
          <div style="color: #7a8fb8; font-size: 14px;">Today's Events</div>
        </div>
        <div class="card">
          <div style="font-size: 32px; margin-bottom: 8px;">â˜‘</div>
          <div style="font-size: 24px; font-weight: bold;" id="task-count">-</div>
          <div style="color: #7a8fb8; font-size: 14px;">Active Tasks</div>
        </div>
        <div class="card">
          <div style="font-size: 32px; margin-bottom: 8px;">âš¡</div>
          <div style="font-size: 24px; font-weight: bold; color: #22c55e;" id="status">ONLINE</div>
          <div style="color: #7a8fb8; font-size: 14px;">System Status</div>
        </div>
      </div>
      
      <div class="grid grid-2" style="margin-top: 24px;">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Recent Emails</h2>
            <a href="emails.html" class="btn btn-secondary">View All â†’</a>
          </div>
          <div id="recent-emails" class="loading"><div class="spinner"></div></div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Upcoming Events</h2>
            <a href="calendar.html" class="btn btn-secondary">View All â†’</a>
          </div>
          <div id="upcoming-events" class="loading"><div class="spinner"></div></div>
        </div>
      </div>
      
      <div class="card" style="margin-top: 24px;">
        <div class="card-header">
          <h2 class="card-title">Active Tasks</h2>
          <a href="tasks.html" class="btn btn-secondary">View All â†’</a>
        </div>
        <div id="active-tasks" class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <script src="victor-app.js"></script>
  <script>
    // Auth check
    const auth = sessionStorage.getItem('victor-auth');
    if (auth === 'authenticated') {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app-container').style.display = 'block';
      loadDashboard();
    } else {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('app-container').style.display = 'none';
    }
    
    // Password input handler
    document.getElementById('password-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') authenticate();
    });
    
    async function loadDashboard() {
      try {
        // Load emails
        const emailData = await VictorApp.api('/victor/emails');
        const emails = emailData.emails || [];
        document.getElementById('email-count').textContent = emails.length;
        
        const emailHtml = emails.slice(0, 3).map(e => `
          <div style="padding: 12px; border-bottom: 1px solid #2f4a70;">
            <div style="font-weight: 500; margin-bottom: 4px;">${escapeHtml(e.subject)}</div>
            <div style="font-size: 13px; color: #7a8fb8;">${escapeHtml(e.from)} â€¢ ${e.date}</div>
          </div>
        `).join('') || '<div class="empty-state">No emails</div>';
        document.getElementById('recent-emails').innerHTML = emailHtml;
        
        // Load calendar
        const calData = await VictorApp.api('/victor/calendar');
        const events = calData.events || [];
        document.getElementById('event-count').textContent = events.length;
        
        const eventHtml = events.slice(0, 3).map(e => `
          <div style="padding: 12px; border-bottom: 1px solid #2f4a70;">
            <div style="font-weight: 500; margin-bottom: 4px;">${escapeHtml(e.summary)}</div>
            <div style="font-size: 13px; color: #7a8fb8;">${formatTime(e.start)} ${e.location ? 'â€¢ ' + escapeHtml(e.location) : ''}</div>
          </div>
        `).join('') || '<div class="empty-state">No events</div>';
        document.getElementById('upcoming-events').innerHTML = eventHtml;
        
        // Load tasks from localStorage
        const tasks = JSON.parse(localStorage.getItem('victor_tasks') || '[]');
        const activeTasks = tasks.filter(t => !t.completed);
        document.getElementById('task-count').textContent = activeTasks.length;
        
        const taskHtml = activeTasks.slice(0, 5).map(t => `
          <div style="padding: 12px; border-bottom: 1px solid #2f4a70; display: flex; align-items: center; gap: 12px;">
            <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTask('${t.id}')" style="width: 18px; height: 18px;">
            <div style="flex: 1;">
              <div style="${t.completed ? 'text-decoration: line-through; color: #7a8fb8;' : ''}">${escapeHtml(t.text)}</div>
              ${t.dueDate ? `<div style="font-size: 12px; color: #7a8fb8;">Due: ${t.dueDate}</div>` : ''}
            </div>
            <span class="badge badge-${t.priority === 'high' ? 'error' : t.priority === 'medium' ? 'warning' : 'info'}">${t.priority}</span>
          </div>
        `).join('') || '<div class="empty-state">No active tasks</div>';
        document.getElementById('active-tasks').innerHTML = taskHtml;
        
      } catch (err) {
        console.error('Dashboard load error:', err);
        document.getElementById('status').textContent = 'ERROR';
        document.getElementById('status').style.color = '#ef4444';
      }
    }
    
    function toggleTask(id) {
      const tasks = JSON.parse(localStorage.getItem('victor_tasks') || '[]');
      const task = tasks.find(t => t.id === id);
      if (task) {
        task.completed = !task.completed;
        localStorage.setItem('victor_tasks', JSON.stringify(tasks));
        loadDashboard();
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    function formatTime(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }
  </script>
</body>
</html>
