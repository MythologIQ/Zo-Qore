<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zo-Qore Command Center</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" href="legacy-roadmap.css?v=18">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;800&display=swap">
</head>
<body>
    <nav class="zoqore-view-toggle" aria-label="View switch">
    <button type="button" data-zoqore-switch>Monitor</button>
  </nav>
  <script>
    (function(){
      var button=document.querySelector('[data-zoqore-switch]');
      if(!button){ return; }
      var path=window.location.pathname||'/';
      var params=new URLSearchParams(window.location.search||'');
      var onMonitor=path.indexOf('/ui/monitor')===0 || (path==='/' && params.get('ui')==='compact');
      button.textContent=onMonitor?'Command Center':'Monitor';
      if(onMonitor){
        var topBar=document.querySelector('.brand');
        var statusLine=document.getElementById('status-line');
        var nav=button.closest('.zoqore-view-toggle');
        if(topBar && nav){
          nav.classList.add('in-bar');
          topBar.appendChild(nav);
        }
        if(statusLine){
          statusLine.classList.add('is-hidden');
        }
      }
      function enforcePopupMonitorSize(){
        if(!onMonitor || params.get('popup')!=='1'){ return; }
        var desiredInnerWidth=parseInt(params.get('w')||'0',10);
        var desiredInnerHeight=parseInt(params.get('h')||'0',10);
        if(!(desiredInnerWidth>0)){
          var bodyW=(document.body&&document.body.scrollWidth)||0;
          var docW=(document.documentElement&&document.documentElement.scrollWidth)||0;
          desiredInnerWidth=Math.max(560, bodyW, docW) + 24;
        }
        if(!(desiredInnerHeight>0)){
          var bodyH=(document.body&&document.body.scrollHeight)||0;
          var docH=(document.documentElement&&document.documentElement.scrollHeight)||0;
          desiredInnerHeight=Math.max(760, bodyH, docH) + 24;
        }
        if(!window.resizeTo){ return; }
        var frameW=Math.max(0, (window.outerWidth||desiredInnerWidth) - (window.innerWidth||desiredInnerWidth));
        var frameH=Math.max(0, (window.outerHeight||desiredInnerHeight) - (window.innerHeight||desiredInnerHeight));
        var maxW=(window.screen && window.screen.availWidth) ? window.screen.availWidth : desiredInnerWidth + frameW;
        var maxH=(window.screen && window.screen.availHeight) ? window.screen.availHeight : desiredInnerHeight + frameH;
        var targetOuterW=Math.min(maxW, desiredInnerWidth + frameW);
        var targetOuterH=Math.min(maxH, desiredInnerHeight + frameH);
        try {
          window.resizeTo(targetOuterW, targetOuterH);
          var left=Math.max(0, Math.floor((((window.screen && window.screen.availWidth) || targetOuterW)-targetOuterW)/2));
          var top=Math.max(0, Math.floor((((window.screen && window.screen.availHeight) || targetOuterH)-targetOuterH)/2));
          if(window.moveTo){ window.moveTo(left, top); }
        } catch (error) {
        }
      }
      enforcePopupMonitorSize();
      function openMonitorPopup(){
        var width=410;
        var height=1060;
        var left=Math.max(0, Math.floor((window.screen.width-width)/2));
        var top=Math.max(0, Math.floor((window.screen.height-height)/2));
        var features='popup=yes,toolbar=no,menubar=no,location=yes,status=no,resizable=yes,scrollbars=yes,width=410,height=1060,left='+left+',top='+top;
        var monitorWindow=window.open('/?ui=compact&popup=1&w='+width+'&h='+height, 'zoqore_monitor', features);
        if(monitorWindow){
          monitorWindow.focus();
          return;
        }
        window.location.assign('/?ui=compact&popup=1&w='+width+'&h='+height);
      }
      function returnToCommandCenter(){
        if(window.opener && !window.opener.closed){
          try {
            window.opener.location.assign('/?ui=full');
            window.opener.focus();
            window.close();
            return;
          } catch (error) {
          }
        }
        window.location.assign('/?ui=full');
      }
      button.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        if(onMonitor){
          returnToCommandCenter();
          return;
        }
        openMonitorPopup();
      }, true);
    })();
  </script>
  <script>
  // ─── Testing UI Controller ────────────────────────────────────
  (function() {
    'use strict';
    var runAllBtn = document.getElementById('testing-run-all');
    var runFailedBtn = document.getElementById('testing-run-failed');
    var stopBtn = document.getElementById('testing-stop');
    var filterInput = document.getElementById('testing-filter');
    var statusFilter = document.getElementById('testing-status-filter');
    var fileListEl = document.getElementById('testing-file-list');
    var outputEl = document.getElementById('testing-output');
    var clearOutputBtn = document.getElementById('testing-clear-output');
    var copyOutputBtn = document.getElementById('testing-copy-output');
    var totalEl = document.getElementById('testing-total');
    var passedEl = document.getElementById('testing-passed');
    var failedEl = document.getElementById('testing-failed');
    var skippedEl = document.getElementById('testing-skipped');
    var durationEl = document.getElementById('testing-duration');
    var progressFillEl = document.getElementById('testing-progress-fill');
    var progressLabelEl = document.getElementById('testing-progress-label');
    var fileCountEl = document.getElementById('testing-file-count');

    var testFiles = [];
    var testModules = [];
    var unindexedFiles = [];
    var testResults = {};
    var isRunning = false;
    var failedFiles = [];

    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function renderFileList(filter, statusFilterVal) {
      if (!fileListEl) return;
      var filt = (filter || '').toLowerCase();
      var html = '';

      // Render grouped by module
      if (testModules.length > 0) {
        testModules.forEach(function(mod) {
          var modFiles = mod.files.filter(function(f) {
            if (filt && f.toLowerCase().indexOf(filt) === -1) return false;
            if (statusFilterVal && statusFilterVal !== 'all') {
              var r = testResults[f];
              if (!r) return statusFilterVal === 'pending';
              if (r.status !== statusFilterVal) return false;
            }
            return true;
          });
          if (modFiles.length === 0) return;
          var passCount = modFiles.filter(function(f) { return testResults[f] && testResults[f].status === 'passed'; }).length;
          var failCount = modFiles.filter(function(f) { return testResults[f] && testResults[f].status === 'failed'; }).length;
          var modStatus = failCount > 0 ? 'failed' : (passCount === modFiles.length && passCount > 0 ? 'passed' : 'pending');
          html += '<div class="testing-module-group">';
          html += '<div class="testing-module-head ' + modStatus + '" data-module="' + escHtml(mod.key) + '">';
          html += '<span class="testing-module-toggle">&#9654;</span>';
          html += '<span class="testing-module-label">' + escHtml(mod.label) + '</span>';
          html += '<span class="testing-module-count">' + modFiles.length + '</span>';
          if (passCount > 0 || failCount > 0) {
            html += '<span class="testing-module-stats">';
            if (passCount > 0) html += '<span class="stat-pass">' + passCount + ' &#10003;</span>';
            if (failCount > 0) html += '<span class="stat-fail">' + failCount + ' &#10007;</span>';
            html += '</span>';
          }
          html += '</div>';
          html += '<div class="testing-module-files">';
          modFiles.forEach(function(f) {
            var r = testResults[f] || { status: 'pending', duration: '' };
            var name = f.split('/').pop();
            html += '<div class="testing-file-item" data-file="' + escHtml(f) + '">';
            html += '<span class="testing-file-status ' + r.status + '"></span>';
            html += '<span class="testing-file-name" title="' + escHtml(f) + '">' + escHtml(name) + '</span>';
            if (r.duration) html += '<span class="testing-file-duration">' + escHtml(r.duration) + '</span>';
            html += '</div>';
          });
          html += '</div></div>';
        });
      } else {
        // Flat list fallback
        var items = testFiles.filter(function(f) {
          if (filt && f.toLowerCase().indexOf(filt) === -1) return false;
          if (statusFilterVal && statusFilterVal !== 'all') {
            var r = testResults[f];
            if (!r) return statusFilterVal === 'pending';
            if (r.status !== statusFilterVal) return false;
          }
          return true;
        });
        items.forEach(function(f) {
          var r = testResults[f] || { status: 'pending', duration: '' };
          var name = f.split('/').pop();
          html += '<div class="testing-file-item" data-file="' + escHtml(f) + '">';
          html += '<span class="testing-file-status ' + r.status + '"></span>';
          html += '<span class="testing-file-name" title="' + escHtml(f) + '">' + escHtml(name) + '</span>';
          if (r.duration) html += '<span class="testing-file-duration">' + escHtml(r.duration) + '</span>';
          html += '</div>';
        });
      }

      // Unindexed files warning (IR-002 governance)
      if (unindexedFiles.length > 0) {
        html += '<div class="testing-unindexed-warning">';
        html += '<div class="testing-unindexed-head">&#9888; IR-002 Violation: ' + unindexedFiles.length + ' unindexed test(s)</div>';
        unindexedFiles.forEach(function(f) {
          var name = f.split('/').pop();
          html += '<div class="testing-file-item unindexed" title="' + escHtml(f) + '">';
          html += '<span class="testing-file-status violation"></span>';
          html += '<span class="testing-file-name">' + escHtml(name) + '</span>';
          html += '</div>';
        });
        html += '</div>';
      }

      if (!html) {
        fileListEl.innerHTML = '<p class="empty-state">No matching test files.</p>';
        return;
      }
      fileListEl.innerHTML = html;

      // Bind click handlers for file items
      fileListEl.querySelectorAll('.testing-file-item:not(.unindexed)').forEach(function(el) {
        el.addEventListener('click', function() {
          var file = el.getAttribute('data-file');
          runSingleFile(file);
        });
      });

      // Bind toggle for module groups
      fileListEl.querySelectorAll('.testing-module-head').forEach(function(el) {
        el.addEventListener('click', function() {
          var group = el.parentElement;
          group.classList.toggle('collapsed');
        });
      });
    }

    function updateKpis(parsed) {
      if (totalEl) totalEl.textContent = parsed.total || 0;
      if (passedEl) passedEl.textContent = parsed.passed || 0;
      if (failedEl) failedEl.textContent = parsed.failed || 0;
      if (skippedEl) skippedEl.textContent = parsed.skipped || 0;
      if (durationEl) durationEl.textContent = parsed.duration || '--';
    }

    function parseVitestOutput(output) {
      var lines = output.split('\n');
      var total = 0, passed = 0, failed = 0, skipped = 0;
      var duration = '--';
      failedFiles = [];
      lines.forEach(function(line) {
        var summaryMatch = line.match(/Tests\s+(\d+)\s+passed/);
        if (summaryMatch) passed = parseInt(summaryMatch[1]);
        var failMatch = line.match(/(\d+)\s+failed/);
        if (failMatch) failed = parseInt(failMatch[1]);
        var skipMatch = line.match(/(\d+)\s+skipped/);
        if (skipMatch) skipped = parseInt(skipMatch[1]);
        var durMatch = line.match(/Duration\s+([\d.]+m?s)/);
        if (durMatch) duration = durMatch[1];
        var testFilesMatch = line.match(/Test Files\s+(\d+)\s+passed/);
        var testFilesFailMatch = line.match(/Test Files\s+.*?(\d+)\s+failed/);
        var failFileMatch = line.match(/FAIL\s+(.+\.test\.(?:ts|js))/);
        if (failFileMatch) failedFiles.push(failFileMatch[1].trim());
      });
      total = passed + failed + skipped;
      testFiles.forEach(function(f) {
        var name = f.split('/').pop();
        var isFailFile = failedFiles.some(function(ff) { return ff.indexOf(name) !== -1 || f.indexOf(ff) !== -1; });
        if (isFailFile) {
          testResults[f] = { status: 'failed', duration: '' };
        } else if (output.indexOf(name) !== -1) {
          testResults[f] = { status: 'passed', duration: '' };
        }
      });
      return { total: total, passed: passed, failed: failed, skipped: skipped, duration: duration };
    }

    function colorizeOutput(raw) {
      return raw.split('\n').map(function(line) {
        if (line.match(/PASS/) || line.match(/\u2713/)) return '<span class="line-pass">' + escHtml(line) + '</span>';
        if (line.match(/FAIL/) || line.match(/\u2717/) || line.match(/Error:/i)) return '<span class="line-fail">' + escHtml(line) + '</span>';
        if (line.match(/skipped/i) || line.match(/\u25CB/)) return '<span class="line-skip">' + escHtml(line) + '</span>';
        if (line.match(/Tests\s|Duration\s|Test Files/)) return '<span class="line-info">' + escHtml(line) + '</span>';
        return escHtml(line);
      }).join('\n');
    }

    function setRunning(running) {
      isRunning = running;
      if (runAllBtn) runAllBtn.disabled = running;
      if (runFailedBtn) runFailedBtn.disabled = running;
      if (stopBtn) stopBtn.disabled = !running;
      if (progressLabelEl) progressLabelEl.textContent = running ? 'Running...' : 'Ready';
      if (progressFillEl) {
        if (running) {
          progressFillEl.style.width = '15%';
          progressFillEl.style.transition = 'width 60s linear';
          setTimeout(function() { progressFillEl.style.width = '85%'; }, 50);
        } else {
          progressFillEl.style.transition = 'width 0.3s ease';
          progressFillEl.style.width = '100%';
          setTimeout(function() { progressFillEl.style.width = '0%'; }, 1500);
        }
      }
    }

    function loadFileList() {
      fetch('/api/testing/files')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok && data.files) {
            testFiles = data.files;
            testModules = data.modules || [];
            unindexedFiles = data.unindexed || [];
            var label = data.count + ' files';
            if (testModules.length > 0) label += ' / ' + testModules.length + ' modules';
            if (data.unindexedCount > 0) label += ' / ' + data.unindexedCount + ' unindexed';
            if (fileCountEl) fileCountEl.textContent = label;
            renderFileList();
          }
        })
        .catch(function() {});
    }

    function runTests(payload) {
      setRunning(true);
      testFiles.forEach(function(f) { testResults[f] = { status: 'running', duration: '' }; });
      renderFileList();
      if (outputEl) outputEl.innerHTML = '<span class="line-info">Running tests...</span>';

      fetch('/api/testing/run', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload || {})
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        setRunning(false);
        var output = data.output || 'No output received.';
        if (outputEl) {
          outputEl.innerHTML = colorizeOutput(output);
          outputEl.scrollTop = outputEl.scrollHeight;
        }
        var parsed = parseVitestOutput(output);
        updateKpis(parsed);
        renderFileList();
        if (progressLabelEl) {
          progressLabelEl.textContent = parsed.failed > 0 ? parsed.failed + ' failed' : 'All passed';
        }
      })
      .catch(function(err) {
        setRunning(false);
        if (outputEl) outputEl.innerHTML = '<span class="line-fail">Error: ' + escHtml(String(err)) + '</span>';
      });
    }

    function runSingleFile(file) {
      testResults[file] = { status: 'running', duration: '' };
      renderFileList();
      runTests({ file: file });
    }

    if (runAllBtn) runAllBtn.addEventListener('click', function() { runTests(); });
    if (runFailedBtn) runFailedBtn.addEventListener('click', function() {
      if (failedFiles.length > 0) {
        runTests({ file: failedFiles[0] });
      } else {
        runTests();
      }
    });

    if (clearOutputBtn) clearOutputBtn.addEventListener('click', function() {
      if (outputEl) outputEl.textContent = 'Waiting for test execution...';
    });
    if (copyOutputBtn) copyOutputBtn.addEventListener('click', function() {
      if (outputEl) navigator.clipboard.writeText(outputEl.textContent).catch(function() {});
    });

    if (filterInput) filterInput.addEventListener('input', function() {
      renderFileList(filterInput.value, statusFilter ? statusFilter.value : 'all');
    });
    if (statusFilter) statusFilter.addEventListener('change', function() {
      renderFileList(filterInput ? filterInput.value : '', statusFilter.value);
    });

    // Load file list when Testing tab is activated (always refresh)
    document.querySelectorAll('.tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        if (tab.getAttribute('data-route') === 'testing') {
          loadFileList();
        }
      });
    });
  })();
  </script>
<aside class="zoqore-side-banner zoqore-side-rail" aria-hidden="true">
    <img src="/zoqore-side-banner.png" alt="">
    <div class="side-beta-callout" aria-hidden="false">
      <span class="side-beta-eyebrow">Open Source Beta</span>
      <h3>Build Zo-Qore With Us</h3>
      <p>Test real governance workflows, surface edge cases, and help ship a stronger platform for everyone building with autonomous systems.</p>
      <a class="hub-action-btn primary side-beta-cta" href="https://github.com/MythologIQ/Zo-Qore" target="_blank" rel="noopener noreferrer">Join the Beta on GitHub</a>
    </div>
  </aside>
  <div id="app">
    <div class="bg-layer-logo"></div>
    <div class="bg-layer-overlay"></div>
    <header id="header">
      <div class="header-content">
        <div class="brand-left">
          <img src="/favicon.png" alt="Zo-Qore logo" class="brand-icon">
          <div>
            <h1>Zo-Qore</h1>
            <div class="brand-subtitle">Command Center</div>
          </div>
        </div>
        <div class="header-controls">
          <div class="account-controls">
            <span id="session-user" class="session-user">Logged in: operator@local</span>
            <button id="session-logout" class="header-btn" type="button">Logout</button>
            <button id="settings-gear" class="header-btn icon-btn" type="button" aria-label="Settings">&#9881;</button>
            <button id="governance-alert-badge" class="header-alert-badge hidden" type="button" aria-label="Critical governance violation — click to view" title="Critical governance violation">
              <span class="alert-badge-icon">&#9888;</span>
              <span class="alert-badge-text">Violation</span>
            </button>
          </div>
          <div id="connection-status" class="status-indicator" aria-live="polite">
            <span class="status-dot"></span>
            <span class="status-text">Connecting...</span>
          </div>
          <div id="resume-summary" class="resume-summary">Loading session...</div>
        </div>
      </div>
      <nav id="tabs" class="tabs" aria-label="Zo-Qore Sections">
        <button class="tab active" data-route="home" type="button">Home</button>
        <button class="tab" data-route="skills" type="button">Comms</button>
        <button class="tab" data-route="persona" type="button">Persona</button>
        <button class="tab" data-route="workflows" type="button">Workflows</button>
        <button class="tab" data-route="projects" type="button">Projects</button>
        <button class="tab" data-route="governance" type="button">Governance</button>
        <button class="tab" data-route="library" type="button">Skill Library</button>
        <button class="tab" data-route="testing" type="button">Testing</button>
        <button class="tab" data-route="reports" type="button">Reports</button>
      </nav>
      <div class="status-strip" aria-live="polite">
        <div class="status-strip-left">
          <span class="status-pill status-pill-governance" id="status-governance-pill" tabindex="0">
            <span class="status-pill-label">Governance Protocol</span>
            <span id="status-governance">Baseline</span>
            <span class="governance-hover-card" id="status-governance-card" role="tooltip">
              <span class="governance-hover-row"><span>Governance Mode</span><strong id="status-governance-mode">Baseline</strong></span>
              <span class="governance-hover-row"><span>Policy Profile</span><strong id="status-governance-profile">Production</strong></span>
              <span class="governance-hover-row"><span>Protocol</span><strong id="status-governance-protocol">GP-01</strong></span>
            </span>
          </span>
          <span class="status-pill status-pill-sentinel">
            <span class="status-pill-label">Sentinel</span>
            <span id="status-sentinel">Nominal</span>
          </span>
        </div>
        <div class="status-strip-right">
          <span><span class="status-dot-mini"></span><span id="status-latency">-- ms</span></span>
          <span><span class="status-dot-mini good"></span><span id="status-load">--</span></span>
          <span id="status-version">v1.0.0</span>
        </div>
      </div>
    </header>

    <main id="main">
      <section id="global-error" class="error-banner hidden" aria-live="polite"></section>

      <section id="panel-home" class="panel route-panel active-panel overview-panel" data-route="home">
        <div class="session-chat-dock card">
          <div class="session-chat-dock-title">Session/Chat ID</div>
          <div class="session-chat-dock-row">
            <span id="session-chat-id" class="session-chat-id-value">pending</span>
            <button id="session-chat-new" class="hub-action-btn primary small" type="button">New Chat</button>
          </div>
          <label class="visually-hidden" for="session-chat-memory">Zo Memory</label>
          <select id="session-chat-memory" class="intent-select session-chat-memory" aria-label="Select chat from Zo memory">
            <option value="">Zo Memory</option>
          </select>
        </div>
        <div class="panel-headline">
          <div class="command-badge">Command Center Active</div>
          <h2>System Overview</h2>
          <p class="panel-subline">Centralized monitoring and orchestration for autonomous intelligence workflows.</p>
        </div>
        <div id="home-kpis" class="overview-cards"></div>
        <section class="home-grid">
          <div class="home-left">
            <article class="card home-stream-card" id="home-operational"></article>
            <div class="home-bottom-grid">
              <article class="card home-resource-card" id="home-resource"></article>
            </div>
          </div>
          <aside class="home-right">
            <article class="card home-node-card" id="home-forensic"></article>
            <article class="card home-nextgen-card" id="home-nextgen"></article>
          </aside>
        </section>
      </section>

      <!-- Run tab removed: components distributed to Governance and Projects tabs -->

      <section id="panel-skills" class="panel route-panel skills-panel" data-route="skills">
        <div class="panel-headline">
          <h2>Prompt Pipeline</h2>
          <p class="panel-subline">Intent-first orchestration with context, skill fit, persona, template deck, and model recommendation.</p>
        </div>

        <section class="intent-shell prompt-pipeline-shell">
          <div class="prompt-grid">
            <div class="prompt-main">
              <div class="prompt-row">
                <label class="intent-label" for="intent-template">Template Deck</label>
                <select id="intent-template" class="intent-select">
                  <option value="planning">Planning</option>
                  <option value="fast">Fast Action</option>
                  <option value="analysis">Deep Analysis</option>
                  <option value="build">Build + Verify</option>
                  <option value="migration">Migration / Refactor</option>
                </select>
              </div>

              <div class="prompt-row">
                <label class="intent-label" for="intent-input">Intent</label>
                <textarea id="intent-input" class="intent-input" rows="4" placeholder="What should be achieved? Define outcome and constraints."></textarea>
              </div>

              <div class="prompt-row">
                <label class="intent-label" for="intent-context-input">Context</label>
                <textarea id="intent-context-input" class="intent-input" rows="4" placeholder="Repository details, dependencies, deadlines, constraints, and acceptance criteria."></textarea>
              </div>

              <div class="prompt-row prompt-row-inline">
                <div>
                  <label class="intent-label" for="intent-persona">Agent Persona</label>
                  <select id="intent-persona" class="intent-select">
                    <option value="systems">Systems Engineer</option>
                    <option value="security">Security Auditor</option>
                    <option value="performance">Performance Optimizer</option>
                    <option value="product">Product Implementer</option>
                  </select>
                </div>
                <div>
                  <label class="intent-label" for="intent-skill-select">Execution Skill</label>
                  <select id="intent-skill-select" class="intent-select">
                    <option value="">Auto (Recommended)</option>
                  </select>
                </div>
                <div>
                  <label class="intent-label" for="intent-model-mode">Model Selection Mode</label>
                  <select id="intent-model-mode" class="intent-select">
                    <option value="auto">Auto Best Value</option>
                    <option value="suggest">Suggest Only</option>
                    <option value="manual">Manual Override</option>
                  </select>
                </div>
              </div>

              <div id="intent-model-manual-row" class="prompt-row model-manual-row" style="display:none;">
                <label class="intent-label" for="intent-model-select">Select Model</label>
                <div class="model-select-grid">
                  <select id="intent-model-select" class="intent-select model-select-dropdown">
                    <option value="">Loading models...</option>
                  </select>
                  <div id="intent-model-detail" class="model-detail-card">
                    <span class="model-detail-placeholder">Select a model to see details</span>
                  </div>
                </div>
              </div>
            </div>

            <aside id="intent-flow-pipeline" class="prompt-side card flow-stage" data-flow-state="pending">
              <h3>Pipeline Guidance</h3>
              <div class="prompt-guidance-grid">
                <article class="guidance-tile tile-context">
                  <h4>Intent Buffer</h4>
                  <div id="intent-context" class="intent-context"></div>
                </article>
                <article class="guidance-tile tile-task">
                  <h4>Task Classification</h4>
                  <div id="intent-task-nature" class="prompt-insight">Task nature: unknown</div>
                </article>
                <article class="guidance-tile tile-model">
                  <h4>Model Recommendation</h4>
                  <div id="intent-model-recommendation" class="prompt-insight">Model recommendation appears after generation.</div>
                </article>
                <article class="guidance-tile tile-practices">
                  <h4>Vendor Practices</h4>
                  <div id="intent-vendor-practices" class="prompt-practices">Vendor prompting best practices for selected model will appear here.</div>
                </article>
              </div>
              <div class="prompt-wishlist">
                <strong>Wishlist:</strong> Persona Management UI is planned for a future release. Add Projects tab with project selector and sub-tabs for Kanban, Gantt Sheet, and Roadmap. Add dedicated Agent Persona and Workflows tabs.
              </div>
            </aside>
          </div>

          <div class="intent-results-grid">
            <section id="intent-flow-chat" class="flow-stage intent-result-panel" data-flow-state="idle">
              <div class="intent-result-head">
                <h4 class="intent-chat-label">Chat OUTPUT</h4>
                <button id="intent-chat-logs" class="hub-action-btn ghost small" type="button" disabled>Chat Logs</button>
              </div>
              <div class="intent-chat-id-row">Session/Chat ID: <span id="intent-chat-id">pending</span></div>
              <pre id="intent-chat-output" class="intent-output intent-chat-output">Assistant responses appear here after send.</pre>
            </section>

            <section id="intent-flow-package" class="flow-stage intent-result-panel" data-flow-state="idle">
              <h4 class="intent-chat-label">Prompt Staging</h4>
              <p class="intent-action-note">Prompt generation is deterministic and non-executing. Edit freely or write your own prompt directly.</p>
              <textarea id="intent-output" class="intent-output intent-package-output" rows="12" placeholder="Enter or edit your prompt here. Use Generate Prompt to auto-fill, or write directly."></textarea>
              <div class="intent-actions intent-generate-row-left">
                <button id="intent-generate" class="hub-action-btn primary intent-generate-xl" type="button">Generate Prompt</button>
                <button id="intent-send" class="hub-action-btn primary" type="button">Send Prompt</button>
              </div>
            </section>
          </div>
        </section>
      </section>

      <section id="panel-library" class="panel route-panel skills-panel" data-route="library">
        <div class="panel-headline">
          <h2>Skill Library</h2>
          <p class="panel-subline">Ingest, curate, and draft skills. Manual and auto workspace ingestion live here.</p>
        </div>

        <section class="card skill-scribe-shell">
          <div class="skill-scribe-head">
            <h3>Skill Scribe</h3>
            <span class="skills-library-badge">Draft Generator</span>
          </div>
          <div class="skill-scribe-grid">
            <textarea id="skill-scribe-goal" class="intent-input" rows="3" placeholder="What job should this new skill solve?"></textarea>
            <textarea id="skill-scribe-guidance" class="intent-input" rows="3" placeholder="Primary guidance, rules, constraints, references, and expected outputs."></textarea>
          </div>
          <div class="skill-scribe-grid">
            <textarea id="skill-scribe-context" class="intent-input" rows="3" placeholder="Add more context iteratively, then click Add Context."></textarea>
            <div class="skill-context-log-shell">
              <div id="skill-scribe-context-log" class="skill-context-log">No additional context captured yet.</div>
            </div>
          </div>
          <div class="intent-actions intent-actions-right">
            <button id="skill-scribe-add-context" class="hub-action-btn" type="button">Add Context</button>
            <button id="skill-scribe-generate" class="hub-action-btn primary" type="button">Generate Skill Draft</button>
            <button id="skill-scribe-copy" class="hub-action-btn ghost" type="button">Copy Draft</button>
          </div>
          <div id="skill-scribe-alert" class="skill-scribe-alert" aria-live="polite"></div>
          <pre id="skill-scribe-output" class="intent-output">Skill draft will appear here.</pre>
        </section>

        <div class="skills-command-grid">
          <div class="skills-library-shell">
            <div class="skills-library-head">
              <h3>Skill Library</h3>
              <div class="skills-library-head-right">
                <span class="skills-buffer-inline">Buffer 14.2%</span>
                <span class="skills-library-badge"><span id="skills-active-count">0</span> Active Modules</span>
              </div>
            </div>
            <div class="skills-toolbar">
              <div class="ingest-head" style="display:none"></div>
              <div class="ingest-branch">
                <button id="skill-manual-ingest" class="hub-action-btn primary ingest-main" type="button" aria-haspopup="menu" aria-expanded="false">Manual Ingest</button>
                <div id="skill-ingest-menu" class="skill-ingest-menu" role="menu" aria-label="Manual ingest options" hidden>
                  <button id="skill-manual-file" class="hub-action-btn ingest-option" type="button" role="menuitem">Ingest Single File</button>
                  <button id="skill-manual-folder" class="hub-action-btn ingest-option" type="button" role="menuitem">Ingest Directory</button>
                </div>
              </div>
              <button id="skill-auto-ingest" class="hub-action-btn auto-workspace" type="button">Auto Workspace</button>
              <div id="skill-phase-label" class="skill-context-title"></div>
              <div id="skill-ingest-status" class="skill-ingest-status">Only admitted local skills are recognized.</div>
              <input id="skill-manual-file-input" type="file" accept=".md,.yml,.yaml,.txt" class="visually-hidden">
              <input id="skill-manual-folder-input" type="file" webkitdirectory directory multiple class="visually-hidden">
            </div>
            <div class="skill-tabs" role="tablist" aria-label="Skill categories">
              <button class="skill-tab active" type="button" role="tab" aria-selected="true" data-skill-tab="recommended">Recommended</button>
              <button class="skill-tab" type="button" role="tab" aria-selected="false" data-skill-tab="allRelevant">All Relevant</button>
              <button class="skill-tab" type="button" role="tab" aria-selected="false" data-skill-tab="allInstalled">All Installed</button>
              <button class="skill-tab" type="button" role="tab" aria-selected="false" data-skill-tab="otherAvailable">Other Available</button>
            </div>

            <div class="skills-layout">
              <section class="skill-group skill-tab-panel active" data-skill-panel="recommended">
                <div class="skill-carousel-controls">
                  <button class="carousel-btn" type="button" data-carousel-target="skill-recommended" data-carousel-dir="prev" aria-label="Previous recommended skills">&lt;</button>
                  <button class="carousel-btn" type="button" data-carousel-target="skill-recommended" data-carousel-dir="next" aria-label="Next recommended skills">&gt;</button>
                </div>
                <div id="skill-recommended" class="skill-list"></div>
              </section>
              <section class="skill-group skill-tab-panel" data-skill-panel="allRelevant">
                <div class="skill-carousel-controls">
                  <button class="carousel-btn" type="button" data-carousel-target="skill-all-relevant" data-carousel-dir="prev" aria-label="Previous relevant skills">&lt;</button>
                  <button class="carousel-btn" type="button" data-carousel-target="skill-all-relevant" data-carousel-dir="next" aria-label="Next relevant skills">&gt;</button>
                </div>
                <div id="skill-all-relevant" class="skill-list"></div>
              </section>
              <section class="skill-group skill-tab-panel" data-skill-panel="allInstalled">
                <div class="skill-carousel-controls">
                  <button class="carousel-btn" type="button" data-carousel-target="skill-all-installed" data-carousel-dir="prev" aria-label="Previous installed skills">&lt;</button>
                  <button class="carousel-btn" type="button" data-carousel-target="skill-all-installed" data-carousel-dir="next" aria-label="Next installed skills">&gt;</button>
                </div>
                <div id="skill-all-installed" class="skill-list"></div>
              </section>
              <section class="skill-group skill-tab-panel" data-skill-panel="otherAvailable">
                <div class="skill-carousel-controls">
                  <button class="carousel-btn" type="button" data-carousel-target="skill-other" data-carousel-dir="prev" aria-label="Previous other skills">&lt;</button>
                  <button class="carousel-btn" type="button" data-carousel-target="skill-other" data-carousel-dir="next" aria-label="Next other skills">&gt;</button>
                </div>
                <div id="skill-other" class="skill-list"></div>
              </section>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-persona" class="panel route-panel" data-route="persona">
        <div class="panel-headline">
          <h2>Agent Persona</h2>
          <p class="panel-subline">Configure and manage reusable persona profiles for prompt generation.</p>
        </div>
        <section class="card coming-soon-card">
          <h3>Coming Soon</h3>
          <p>Persona profile management UI is in progress. This tab will support persona creation, tuning, and selection presets.</p>
        </section>
      </section>

      <section id="panel-workflows" class="panel route-panel" data-route="workflows">
        <div class="panel-headline">
          <h2>Workflows</h2>
          <p class="panel-subline">Create and orchestrate reusable execution workflows for common task patterns.</p>
        </div>
        <section class="card coming-soon-card">
          <h3>Coming Soon</h3>
          <p>Workflow authoring and sequencing controls are in progress. This tab will host reusable multi-step execution flows.</p>
        </section>
      </section>

      <section id="panel-projects" class="panel route-panel projects-shell" data-route="projects">
        <div class="panel-headline">
          <h2>Projects</h2>
          <p class="panel-subline">Project-level planning and tracking surfaces for delivery execution.</p>
        </div>

        <div class="projects-toolbar">
          <div class="projects-selector">
            <label class="projects-selector-label" for="project-select">Active Project</label>
            <select id="project-select" class="projects-select">
              <option value="default">FailSafe-Qore (Primary)</option>
            </select>
            <button id="project-new" class="hub-action-btn primary small" type="button">+ New Project</button>
          </div>
          <div class="projects-meta">
            <span class="projects-meta-item"><span class="projects-meta-key">State</span><span id="project-state" class="projects-meta-value state-pill state-executing">Executing</span></span>
            <span class="projects-meta-item"><span class="projects-meta-key">Phases</span><span id="project-phase-count" class="projects-meta-value">4</span></span>
            <span class="projects-meta-item"><span class="projects-meta-key">Tasks</span><span id="project-task-count" class="projects-meta-value">13</span></span>
            <span class="projects-meta-item"><span class="projects-meta-key">Risks</span><span id="project-risk-count" class="projects-meta-value">6</span></span>
          </div>
        </div>

        <div class="projects-subtabs" role="tablist" aria-label="Project views">
          <button class="projects-subtab active" type="button" data-project-subtab="overview">Overview</button>
          <button class="projects-subtab" type="button" data-project-subtab="kanban">Kanban</button>
          <button class="projects-subtab" type="button" data-project-subtab="gantt">Gantt</button>
          <button class="projects-subtab" type="button" data-project-subtab="roadmap">Roadmap</button>
          <button class="projects-subtab" type="button" data-project-subtab="brainstorm">Brainstorm</button>
          <button class="projects-subtab" type="button" data-project-subtab="settings">Settings</button>
        </div>

        <!-- Overview Sub-tab -->
        <section class="projects-panel active" data-project-panel="overview">
          <div class="projects-overview-grid">
            <article class="card projects-card">
              <h3>Project Summary</h3>
              <div id="project-summary" class="project-summary-content">
                <p class="empty-state">Loading project data...</p>
              </div>
            </article>
            <article class="card projects-card">
              <h3>Phase Progress</h3>
              <div id="project-phase-progress" class="project-phase-bars">
                <p class="empty-state">Loading phases...</p>
              </div>
            </article>
            <article class="card projects-card">
              <h3>Milestones</h3>
              <div id="project-milestones" class="project-milestones-list">
                <p class="empty-state">Loading milestones...</p>
              </div>
            </article>
            <article class="card projects-card">
              <h3>Risk Summary</h3>
              <div id="project-risk-matrix" class="project-risk-grid">
                <p class="empty-state">Loading risks...</p>
              </div>
            </article>
            <article class="card projects-card">
              <h3>Sub-Projects</h3>
              <div id="project-sub-projects" class="project-subprojects-content">
                <p class="empty-state">Loading sub-projects...</p>
              </div>
            </article>
          </div>
        </section>

        <!-- Kanban Sub-tab -->
        <section class="projects-panel" data-project-panel="kanban">
          <div id="kanban-board" class="kanban-board">
            <p class="empty-state">Loading kanban board...</p>
          </div>
        </section>

        <!-- Gantt Sub-tab -->
        <section class="projects-panel" data-project-panel="gantt">
          <div id="gantt-chart" class="gantt-chart">
            <p class="empty-state">Loading gantt chart...</p>
          </div>
        </section>

        <!-- Roadmap Sub-tab -->
        <section class="projects-panel" data-project-panel="roadmap">
          <div id="roadmap-timeline" class="project-roadmap-timeline">
            <p class="empty-state">Loading roadmap...</p>
          </div>
        </section>

        <!-- Brainstorm / Mind Map Sub-tab -->
        <section class="projects-panel" data-project-panel="brainstorm">
          <!-- Input Control Bar -->
          <div class="brainstorm-input-bar">
            <div class="brainstorm-input-bar-left">
              <button class="brainstorm-record-btn" id="brainstorm-record-btn" type="button" title="Record idea">
                <span class="brainstorm-rec-dot"></span>
                <span class="brainstorm-rec-label">Record</span>
              </button>
              <span class="brainstorm-rec-timer" id="brainstorm-rec-timer"></span>
              <button class="brainstorm-send-btn" id="brainstorm-send-btn" type="button" title="Send recording to mind map" disabled>
                <span class="brainstorm-send-label">Send to Mind Map</span>
              </button>
            </div>
            <div class="brainstorm-input-bar-center">
              <input type="text" class="brainstorm-quick-input" id="brainstorm-quick-input" placeholder="Type an idea and press Enter..." autocomplete="off" />
              <button class="brainstorm-add-btn" id="brainstorm-add-btn" type="button">Add</button>
            </div>
            <div class="brainstorm-input-bar-right">
              <span id="brainstorm-rec-status" class="brainstorm-rec-status"></span>
              <span class="brainstorm-idea-count" id="brainstorm-idea-count">0 ideas</span>
            </div>
          </div>

          <!-- Progress Bars -->
          <div id="brainstorm-progress" class="brainstorm-progress" style="display:none">
            <div class="brainstorm-progress-phase" id="progress-phase-label">Uploading...</div>
            <div class="brainstorm-progress-track">
              <div class="brainstorm-progress-fill" id="progress-fill" style="width:0%"></div>
            </div>
          </div>

          <!-- 3D Constellation Canvas -->
          <div class="brainstorm-canvas-wrapper">
            <div class="brainstorm-canvas-controls">
              <button id="brainstorm-view-toggle" class="hub-action-btn ghost small brainstorm-view-toggle" type="button">Switch to 3D</button>
              <button id="brainstorm-fullscreen-toggle" class="hub-action-btn ghost small brainstorm-fullscreen-toggle" type="button" title="Fullscreen">&#x26F6;</button>
            </div>
            <div id="brainstorm-3d-canvas" class="brainstorm-3d-canvas">
              <p class="empty-state">Loading mind map...</p>
            </div>

            <!-- Node Detail Modal (inside wrapper for fullscreen support) -->
            <div id="constellation-modal" class="constellation-modal">
              <div class="constellation-modal-card">
                <button id="constellation-modal-close" class="constellation-modal-close" type="button" aria-label="Close">&times;</button>
                <h3 id="constellation-modal-title" class="constellation-modal-title">Concept</h3>
                <div id="constellation-modal-body" class="constellation-modal-body">
                </div>
              </div>
            </div>
          </div>

        </section>

        <!-- Settings Sub-tab -->
        <section class="projects-panel" data-project-panel="settings">
          <div class="projects-settings-grid">
            <article class="card projects-card">
              <h3>Governance Policy</h3>
              <div id="project-settings-governance">
                <p class="empty-state">Loading governance settings...</p>
              </div>
            </article>
            <article class="card projects-card">
              <h3>Guardrails</h3>
              <div id="project-settings-guardrails">
                <p class="empty-state">Loading guardrails...</p>
              </div>
            </article>
          </div>
        </section>
      </section>

      <section id="panel-governance" class="panel route-panel governance-panel governance-shell" data-route="governance">
        <div class="panel-headline">
          <h2>System Governance</h2>
          <p class="panel-subline">Unified oversight of protocol health and policy enforcement signals.</p>
        </div>

        <section class="governance-panic-strip">
          <button class="hub-action-btn warn panic-stop-btn" type="button" data-action="panic" id="governance-panic-stop">Panic Stop</button>
          <span class="panic-strip-label">Emergency halt — stops all active monitoring and elevates risk state.</span>
        </section>

        <section class="governance-layout">
          <div class="governance-left-col">
            <article class="card governance-card"><h3>Sentinel Status</h3><div id="sentinel-status"></div></article>
            <article class="card governance-card"><h3>Active Policies</h3><div id="trust-summary"></div></article>
          </div>
          <div class="governance-right-col">
            <article class="card governance-card queue-card">
              <div class="governance-card-head">
                <h3>L3 Verification Queue</h3>
                <button class="hub-action-btn primary small" type="button">Process All</button>
              </div>
              <div id="l3-queue"></div>
            </article>
            <article class="card governance-card audit-card">
              <div class="governance-card-head">
                <h3>Protocol Audit Logs</h3>
                <span class="governance-stream-tag">RT_STREAM: STABLE</span>
              </div>
              <div id="sentinel-alerts"></div>
            </article>
          </div>
        </section>

        <section class="governance-immutable-strip">
          <article class="card governance-card immutable-rules-card">
            <div class="governance-card-head">
              <h3>Immutable Rules</h3>
              <span class="immutable-badge">ENFORCED</span>
            </div>
            <div id="immutable-rules" class="immutable-rules-list">
              <div class="immutable-rule">
                <div class="immutable-rule-icon">⚠</div>
                <div class="immutable-rule-body">
                  <div class="immutable-rule-id">IR-001</div>
                  <div class="immutable-rule-text">We build the tests to validate the things we build, during or even before the build itself.</div>
                  <div class="immutable-rule-meta">
                    <span class="immutable-rule-scope">Scope: All Builds</span>
                    <span class="immutable-rule-enforcement">Enforcement: Mandatory</span>
                    <span class="immutable-rule-added">Since: Genesis</span>
                  </div>
                </div>
                <div class="immutable-rule-lock">🔒</div>
              </div>
            </div>
          </article>
        </section>

        <section class="governance-actions-strip">
          <article class="card governance-card">
            <h3>Hub Actions</h3>
            <div id="hub-actions" class="hub-actions-row"></div>
            <div id="action-feedback" class="action-feedback"></div>
          </article>
          <article class="card governance-card">
            <h3>Performance Telemetry</h3>
            <div id="workspace-health"></div>
          </article>
        </section>
      </section>

      <section id="panel-testing" class="panel route-panel testing-shell" data-route="testing">
        <div class="panel-headline">
          <h2>End-to-End Testing</h2>
          <p class="panel-subline">Validate builds with comprehensive test execution. Tests validate the things we build, during or even before the build itself.</p>
        </div>

        <section class="testing-controls-strip">
          <div class="testing-controls-left">
            <button id="testing-run-all" class="hub-action-btn primary" type="button">Run All Tests</button>
            <button id="testing-run-failed" class="hub-action-btn" type="button">Re-run Failed</button>
            <button id="testing-stop" class="hub-action-btn warn" type="button" disabled>Stop</button>
          </div>
          <div class="testing-controls-right">
            <label class="testing-filter-label" for="testing-filter">Filter</label>
            <input id="testing-filter" class="testing-filter-input" type="text" placeholder="Filter by test name...">
            <select id="testing-status-filter" class="testing-status-select">
              <option value="all">All</option>
              <option value="passed">Passed</option>
              <option value="failed">Failed</option>
              <option value="skipped">Skipped</option>
              <option value="running">Running</option>
            </select>
          </div>
        </section>

        <section class="testing-summary-strip">
          <div class="testing-kpi">
            <div class="testing-kpi-value" id="testing-total">0</div>
            <div class="testing-kpi-label">Total</div>
          </div>
          <div class="testing-kpi passed">
            <div class="testing-kpi-value" id="testing-passed">0</div>
            <div class="testing-kpi-label">Passed</div>
          </div>
          <div class="testing-kpi failed">
            <div class="testing-kpi-value" id="testing-failed">0</div>
            <div class="testing-kpi-label">Failed</div>
          </div>
          <div class="testing-kpi skipped">
            <div class="testing-kpi-value" id="testing-skipped">0</div>
            <div class="testing-kpi-label">Skipped</div>
          </div>
          <div class="testing-kpi duration">
            <div class="testing-kpi-value" id="testing-duration">--</div>
            <div class="testing-kpi-label">Duration</div>
          </div>
          <div class="testing-progress-bar">
            <div class="testing-progress-track">
              <div class="testing-progress-fill" id="testing-progress-fill" style="width:0%"></div>
            </div>
            <div class="testing-progress-label" id="testing-progress-label">Ready</div>
          </div>
        </section>

        <section class="testing-layout">
          <div class="testing-file-list-col">
            <article class="card testing-card">
              <div class="governance-card-head">
                <h3>Test Files</h3>
                <span class="testing-file-count" id="testing-file-count">0 files</span>
              </div>
              <div id="testing-file-list" class="testing-file-list">
                <p class="empty-state">Click "Run All Tests" to discover and execute tests.</p>
              </div>
            </article>
          </div>
          <div class="testing-output-col">
            <article class="card testing-card output-card">
              <div class="governance-card-head">
                <h3>Test Output</h3>
                <div class="testing-output-controls">
                  <button id="testing-clear-output" class="hub-action-btn ghost small" type="button">Clear</button>
                  <button id="testing-copy-output" class="hub-action-btn ghost small" type="button">Copy</button>
                </div>
              </div>
              <pre id="testing-output" class="testing-output">Waiting for test execution...</pre>
            </article>
          </div>
        </section>
      </section>

      <section id="panel-reports" class="panel route-panel reports-shell" data-route="reports" data-min-profile="standard">
        <h2>Reports</h2>
        <div class="reports-subtabs" role="tablist" aria-label="Reports sections">
          <button class="reports-subtab active" type="button" data-report-subtab="summary">Summary</button>
          <button class="reports-subtab" type="button" data-report-subtab="activity">Activity Logs</button>
        </div>
        <section class="reports-panel active" data-report-panel="summary">
          <section class="split-grid">
            <article class="card" id="reports-summary"></article>
            <article class="card" id="reports-evidence" data-min-profile="expert"></article>
          </section>
        </section>
        <section class="reports-panel" data-report-panel="activity">
          <div class="activity-head">
            <div>
              <h3>Activity Log</h3>
              <p class="panel-subline">System-wide event telemetry and execution auditing.</p>
            </div>
            <div class="activity-controls">
              <button id="focus-toggle" class="focus-toggle" type="button" aria-pressed="false">Focus Mode: Off</button>
              <button id="activity-filter" class="focus-toggle" type="button" aria-pressed="false" disabled>Filter Events</button>
            </div>
          </div>
          <div id="event-stream" class="event-stream"></div>
        </section>
      </section>

      <section id="panel-settings" class="panel route-panel" data-route="settings">
        <div class="panel-headline">
          <h2>Control Surface</h2>
          <p class="panel-subline">Tune runtime behavior, visuals, and operational preferences.</p>
        </div>
        <div class="settings-grid">
          <section class="settings-card">
            <h3>Visual Theme</h3>
            <div class="settings-control-row">
              <label class="settings-label" for="theme-select">Theme</label>
              <select id="theme-select" aria-label="Theme selection">
                <option value="auto">Auto</option>
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="high-contrast">High Contrast</option>
                <option value="antigravity">Antigravity</option>
              </select>
            </div>
            <div class="theme-quick-picks">
              <button class="theme-chip" type="button" data-theme-choice="auto">Auto</button>
              <button class="theme-chip" type="button" data-theme-choice="dark">Dark</button>
              <button class="theme-chip" type="button" data-theme-choice="light">Light</button>
              <button class="theme-chip" type="button" data-theme-choice="high-contrast">High Contrast</button>
              <button class="theme-chip" type="button" data-theme-choice="antigravity">Antigravity</button>
            </div>
          </section>


        </div>
      </section>
    </main>

    <footer id="footer">
      <span>Zo-Qore is an open source project by <a href="https://www.MythologIQ.studio" target="_blank" rel="noopener noreferrer">MythologIQ Labs, LLC</a>, provided "as is" without warranty of any kind.</span>
    </footer>
  </div>

  <script type="module" src="legacy/main.js?v=11"></script>
  <script src="constellation-3d.js?v=1"></script>
  <script>
  (function() {
    'use strict';

    // ─── 3D Constellation Init (deferred until brainstorm tab is visible) ───
    var canvas3d = document.getElementById('brainstorm-3d-canvas');
    var viewToggleBtn = document.getElementById('brainstorm-view-toggle');
    var fullscreenBtn = document.getElementById('brainstorm-fullscreen-toggle');
    var constellationMounted = false;
    var pendingConstellationData = null;

    function initConstellation() {
      if (constellationMounted || !canvas3d || !window.Constellation3D) return;
      // Only mount when the canvas container is actually visible and has dimensions
      if (canvas3d.clientWidth === 0 || canvas3d.clientHeight === 0) return;
      Constellation3D.mount(canvas3d);
      constellationMounted = true;
      if (pendingConstellationData) {
        Constellation3D.setState(pendingConstellationData);
        pendingConstellationData = null;
      }
    }

    // Pre-fetch dashboard data (works even while hidden)
    fetch('/api/projects/dashboard')
      .then(function(res) { return res.json(); })
      .then(function(dashboard) {
        if (dashboard && dashboard.project && dashboard.project.id) {
          activeProjectId = dashboard.project.id;
        }
        if (dashboard && dashboard.constellation) {
          if (constellationMounted && window.Constellation3D) {
            Constellation3D.setState(dashboard.constellation);
          } else {
            pendingConstellationData = dashboard.constellation;
          }
        }
      })
      .catch(function(err) { console.warn('[Constellation] Initial load failed:', err); });

    // Listen for brainstorm sub-tab activation to mount
    document.querySelectorAll('.projects-subtab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        if (tab.getAttribute('data-project-subtab') === 'brainstorm') {
          // Small delay to let CSS display take effect so dimensions are available
          setTimeout(initConstellation, 100);
        }
      });
    });

    // 2D/3D toggle button
    if (viewToggleBtn && window.Constellation3D) {
      viewToggleBtn.addEventListener('click', function() {
        if (!constellationMounted) {
          initConstellation();
          return;
        }
        var is3D = Constellation3D.toggleView();
        viewToggleBtn.textContent = is3D ? 'Switch to 2D' : 'Switch to 3D';
      });
    }

    // Fullscreen toggle button
    if (fullscreenBtn && window.Constellation3D) {
      fullscreenBtn.addEventListener('click', function() {
        if (!constellationMounted) {
          initConstellation();
          return;
        }
        Constellation3D.toggleFullscreen();
      });
    }

    // ─── Element refs (all null-guarded) ───────────────────
    var recordBtn = document.getElementById('brainstorm-record-btn');
    var sendBtn = document.getElementById('brainstorm-send-btn');
    var timerEl = document.getElementById('brainstorm-rec-timer');
    var statusEl = document.getElementById('brainstorm-rec-status');
    var countEl = document.getElementById('brainstorm-idea-count');
    var quickInput = document.getElementById('brainstorm-quick-input');
    var addBtn = document.getElementById('brainstorm-add-btn');
    var progressWrap = document.getElementById('brainstorm-progress');
    var progressLabel = document.getElementById('progress-phase-label');
    var progressFill = document.getElementById('progress-fill');

    var recorder = null;
    var recChunks = [];
    var recBlob = null;
    var recStart = 0;
    var recInterval = null;
    var ideaCount = 0;
    var progressTimer = null;
    var activeProjectId = null;

    function getProjectId() {
      if (activeProjectId) return activeProjectId;
      var params = new URLSearchParams(window.location.search);
      return params.get('project') || 'default-project';
    }

    function setStatus(msg, cls) {
      if (!statusEl) return;
      statusEl.textContent = msg;
      statusEl.className = 'brainstorm-rec-status' + (cls ? ' ' + cls : '');
    }

    function updateTimer() {
      if (!timerEl) return;
      var sec = Math.floor((Date.now() - recStart) / 1000);
      var m = String(Math.floor(sec / 60)).padStart(2, '0');
      var s = String(sec % 60).padStart(2, '0');
      timerEl.textContent = m + ':' + s;
    }

    function updateCount() {
      if (countEl) countEl.textContent = ideaCount + ' idea' + (ideaCount !== 1 ? 's' : '');
    }

    // ─── Progress Bar Helpers ───────────────────────────────
    function showProgress(label) {
      if (!progressWrap) return;
      progressWrap.style.display = '';
      if (progressLabel) progressLabel.textContent = label || 'Processing...';
      if (progressFill) { progressFill.style.width = '0%'; progressFill.className = 'brainstorm-progress-fill'; }
    }

    function animateProgress(targetPct, durationMs, callback) {
      if (!progressFill) { if (callback) callback(); return; }
      var start = parseFloat(progressFill.style.width) || 0;
      var range = targetPct - start;
      var t0 = performance.now();
      if (progressTimer) cancelAnimationFrame(progressTimer);
      function step(now) {
        var elapsed = now - t0;
        var pct = Math.min(1, elapsed / durationMs);
        progressFill.style.width = (start + range * pct).toFixed(1) + '%';
        if (pct < 1) { progressTimer = requestAnimationFrame(step); }
        else { if (callback) callback(); }
      }
      progressTimer = requestAnimationFrame(step);
    }

    function hideProgress() {
      if (progressTimer) { cancelAnimationFrame(progressTimer); progressTimer = null; }
      if (progressFill) progressFill.className = 'brainstorm-progress-fill done';
      setTimeout(function() {
        if (progressWrap) progressWrap.style.display = 'none';
        if (progressFill) { progressFill.style.width = '0%'; progressFill.className = 'brainstorm-progress-fill'; }
      }, 600);
    }

    function setSendLabel(text) {
      if (!sendBtn) return;
      var el = sendBtn.querySelector('.brainstorm-send-label');
      if (el) el.textContent = text;
    }

    function setRecLabel(text) {
      if (!recordBtn) return;
      var el = recordBtn.querySelector('.brainstorm-rec-label');
      if (el) el.textContent = text;
    }

    // ─── Record / Stop ────────────────────────────────────
    if (recordBtn) {
      recordBtn.addEventListener('click', function() {
        if (recorder && recorder.state === 'recording') {
          recorder.stop();
          clearInterval(recInterval);
          recordBtn.classList.remove('recording');
          setRecLabel('Record');
        } else {
          navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
            recChunks = [];
            recBlob = null;
            recorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
            recorder.ondataavailable = function(e) { if (e.data.size > 0) recChunks.push(e.data); };
            recorder.onstop = function() {
              stream.getTracks().forEach(function(t) { t.stop(); });
              recBlob = new Blob(recChunks, { type: 'audio/webm' });
              if (sendBtn) sendBtn.disabled = false;
              setStatus('Recording ready. Send to mind map.', '');
            };
            recorder.start(250);
            recStart = Date.now();
            recordBtn.classList.add('recording');
            setRecLabel('Stop');
            if (sendBtn) sendBtn.disabled = true;
            setStatus('Recording...', '');
            recInterval = setInterval(updateTimer, 250);
          }).catch(function(err) {
            console.error('[Brainstorm] Mic error:', err);
            setStatus('Microphone access denied.', 'error');
          });
        }
      });
    }

    // ─── Send recording with progress bar ─────────────────
    if (sendBtn) {
      sendBtn.addEventListener('click', function() {
        if (!recBlob) return;
        var projectId = getProjectId();
        sendBtn.disabled = true;
        setSendLabel('Sending\u2026');

        // Phase 1: Upload & Transcribe
        showProgress('Uploading & transcribing...');
        animateProgress(60, 2000); // animate to 60% over 2s while waiting for server
        setStatus('Uploading and transcribing\u2026', '');

        var fd = new FormData();
        fd.append('audio', recBlob, 'brainstorm-' + Date.now() + '.webm');
        fd.append('projectId', projectId);
        fd.append('target', 'constellation');

        fetch('/api/projects/brainstorm/ingest', { method: 'POST', body: fd })
          .then(function(res) {
            if (!res.ok) throw new Error('Ingest failed (' + res.status + ')');
            return res.json();
          })
          .then(function(data) {
            recBlob = null;
            if (timerEl) timerEl.textContent = '';

            // Phase 2: Adding to mind map
            if (progressLabel) progressLabel.textContent = 'Adding ideas to mind map...';
            animateProgress(95, 1500, function() {
              // Complete
              animateProgress(100, 200, function() {
                hideProgress();
              });
            });

            setSendLabel('Send to Mind Map');
            setStatus('Sent! Weaving into mind map...', 'success');
            ideaCount++;
            updateCount();
            setTimeout(function() { setStatus('', ''); }, 4000);

            // Trigger live refresh
            refreshConstellation();
          })
          .catch(function(err) {
            console.error('[Brainstorm] Send error:', err);
            hideProgress();
            setSendLabel('Send to Mind Map');
            sendBtn.disabled = false;
            setStatus('Failed to send. Try again.', 'error');
          });
      });
    }

    // ─── Quick Text Input with progress ───────────────────
    function submitQuickIdea() {
      if (!quickInput) return;
      var text = quickInput.value.trim();
      if (!text) return;
      quickInput.value = '';
      ideaCount++;
      updateCount();

      showProgress('Adding idea to mind map...');
      animateProgress(70, 800);

      fetch('/api/projects/brainstorm/idea', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ projectId: getProjectId(), content: text })
      })
      .then(function(res) {
        if (!res.ok) throw new Error('Idea failed (' + res.status + ')');
        return res.json();
      })
      .then(function() {
        animateProgress(100, 300, function() { hideProgress(); });
        refreshConstellation();
      })
      .catch(function(err) {
        console.error('[Brainstorm] Quick idea error:', err);
        hideProgress();
      });
    }

    if (quickInput) {
      quickInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); submitQuickIdea(); }
      });
    }
    if (addBtn) {
      addBtn.addEventListener('click', submitQuickIdea);
    }

    // ─── Live constellation refresh ──────────────────────
    function refreshConstellation() {
      if (!window.Constellation3D) return;
      fetch('/api/projects/dashboard')
        .then(function(res) { return res.json(); })
        .then(function(dashboard) {
          if (dashboard && dashboard.constellation) {
            Constellation3D.setState(dashboard.constellation);
          }
        })
        .catch(function() {});
    }

    // Also refresh on custom event (from legacy code)
    window.addEventListener('brainstorm:recording-ingested', function() {
      refreshConstellation();
    });

    // ─── WebSocket live refresh ──────────────────────────
    // Listen for server broadcasts via the existing DataClient WS.
    // When a brainstorm:ingested message arrives, refresh the map.
    window.addEventListener('message', function(ev) {
      try {
        var msg = (typeof ev.data === 'string') ? JSON.parse(ev.data) : ev.data;
        if (msg && msg.type === 'brainstorm:ingested') {
          refreshConstellation();
        }
      } catch(e) {}
    });
    // Hook into the DataClient's WebSocket if available
    (function hookWS() {
      var origOnMessage = null;
      function tryHook() {
        var ws = window.__dataClientWs;
        if (ws && ws.onmessage && ws.onmessage !== origOnMessage) {
          var prev = ws.onmessage;
          origOnMessage = function(ev) {
            prev.call(ws, ev);
            try {
              var msg = JSON.parse(ev.data);
              if (msg && msg.type === 'brainstorm:ingested') {
                refreshConstellation();
              }
            } catch(e) {}
          };
          ws.onmessage = origOnMessage;
        } else {
          setTimeout(tryHook, 2000);
        }
      }
      tryHook();
    })();
  })();
  </script>
</body>
</html>

