<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Victor - Chat</title>
  <link rel="icon" href="/failsafe-icon.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a1220; color: #e7efff; min-height: 100vh; }
    
    /* Login Screen */
    #login-screen { display: none; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #0a1220 0%, #13223a 100%); }
    .login-box { background: #13223a; border: 1px solid #2f4a70; border-radius: 12px; padding: 40px; text-align: center; max-width: 400px; width: 90%; }
    .login-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #1e3a5f, #5a9cf8); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 36px; font-weight: bold; color: white; }
    .login-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .login-subtitle { color: #7a8fb8; margin-bottom: 24px; }
    .login-input { width: 100%; padding: 12px 16px; border: 1px solid #2f4a70; border-radius: 8px; background: #0f1b30; color: #e7efff; font-size: 16px; margin-bottom: 16px; outline: none; }
    .login-input:focus { border-color: #5a9cf8; }
    .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #1e3a5f, #5a9cf8); border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
    .shake { animation: shake 0.5s ease-in-out; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    
    /* Navigation */
    .victor-nav { display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; background: #0d1a2d; border-bottom: 1px solid #2f4a70; }
    .nav-brand { display: flex; align-items: center; gap: 12px; }
    .nav-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #1e3a5f, #5a9cf8); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
    .nav-title { font-size: 18px; font-weight: 600; }
    .nav-links { display: flex; gap: 4px; }
    .nav-link { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 6px; color: #7a8fb8; text-decoration: none; font-size: 14px; transition: all 0.2s; }
    .nav-link:hover { background: #162d4a; color: #e7efff; }
    .nav-link.active { background: #1e3a5f; color: #e7efff; }
    .nav-logout { padding: 8px 16px; background: transparent; border: 1px solid #2f4a70; border-radius: 6px; color: #7a8fb8; font-size: 14px; cursor: pointer; }
    .nav-logout:hover { background: #ef4444; border-color: #ef4444; color: white; }
    
    /* App Container */
    #app-container { display: none; }
    .chat-layout { display: flex; height: calc(100vh - 60px); }
    
    /* Sidebar */
    .sidebar { width: 260px; background: #0d1a2d; border-right: 1px solid #2f4a70; display: flex; flex-direction: column; }
    .sidebar-header { padding: 12px; border-bottom: 1px solid #2f4a70; display: flex; align-items: center; justify-content: space-between; }
    .sidebar-header h2 { font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .sidebar-header h2 svg { width: 16px; height: 16px; color: #5a9cf8; }
    .new-chat-btn { background: #1e3a5f; border: none; color: #5a9cf8; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 18px; }
    .new-chat-btn:hover { background: #2f4a70; }
    .sessions-list { flex: 1; overflow-y: auto; padding: 8px; }
    .session-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-size: 13px; display: flex; align-items: center; gap: 8px; color: #7a8fb8; }
    .session-item:hover { background: #162d4a; }
    .session-item.active { background: #1e3a5f; color: #e7efff; }
    .session-item svg { width: 14px; height: 14px; flex-shrink: 0; }
    
    /* Main Chat */
    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .header { padding: 12px 16px; background: #0d1a2d; border-bottom: 1px solid #2f4a70; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .victor-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: linear-gradient(135deg, #1e3a5f, #5a9cf8); }
    .victor-info h1 { font-size: 16px; font-weight: 600; }
    .victor-info p { font-size: 11px; color: #7a8fb8; }
    
    /* Model Selector */
    .model-selector { position: relative; }
    .model-btn { background: #1e3a5f; border: none; color: #e7efff; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; }
    .model-btn:hover { background: #2f4a70; }
    .model-dropdown { position: absolute; top: 100%; right: 0; margin-top: 4px; background: #0d1a2d; border: 1px solid #2f4a70; border-radius: 8px; min-width: 200px; display: none; z-index: 100; }
    .model-dropdown.open { display: block; }
    .model-option { padding: 10px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #1e3a5f; }
    .model-option:last-child { border-bottom: none; }
    .model-option:hover { background: #1e3a5f; }
    .model-option.selected { color: #5a9cf8; }
    .model-option span { display: block; font-size: 11px; color: #5a7a9a; margin-top: 2px; }
    
    /* Voice Toggle */
    .voice-toggle { background: #162d4a; border: none; color: #5a7a9a; padding: 8px; border-radius: 6px; cursor: pointer; margin-left: 8px; }
    .voice-toggle.active { background: #1e3a5f; color: #5a9cf8; }
    
    /* Messages */
    .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
    .message { display: flex; gap: 12px; max-width: 85%; }
    .message.user { flex-direction: row-reverse; margin-left: auto; }
    .message-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
    .message.user .message-avatar { background: #5a9cf8; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
    .message-content { padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.5; white-space: pre-wrap; }
    .message.assistant .message-content { background: #162d4a; }
    .message.user .message-content { background: #5a9cf8; }
    
    /* Empty State */
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #5a7a9a; }
    .empty-state img { width: 120px; height: 120px; border-radius: 50%; margin-bottom: 16px; object-fit: cover; }
    .empty-state p { font-size: 14px; }
    
    /* Loading */
    .loading { display: flex; gap: 4px; padding: 12px 16px; }
    .loading span { width: 8px; height: 8px; background: #5a9cf8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
    .loading span:nth-child(1) { animation-delay: -0.32s; }
    .loading span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    
    /* Input */
    .input-area { padding: 16px; background: #0d1a2d; border-top: 1px solid #2f4a70; }
    .input-wrapper { display: flex; gap: 8px; align-items: flex-end; }
    .input-wrapper textarea { flex: 1; background: #162d4a; border: none; color: #e7efff; padding: 12px 16px; border-radius: 12px; font-size: 14px; resize: none; min-height: 48px; max-height: 200px; font-family: inherit; }
    .input-wrapper textarea:focus { outline: 2px solid #5a9cf8; }
    .input-wrapper textarea::placeholder { color: #5a7a9a; }
    .input-wrapper button { background: #5a9cf8; border: none; color: white; padding: 12px; border-radius: 12px; cursor: pointer; font-size: 18px; }
    .input-wrapper button:hover { background: #4a8ce8; }
    .input-wrapper button:disabled { background: #2f4a70; cursor: not-allowed; }
    .stop-btn { background: #ef4444; }
    .stop-btn:hover { background: #dc2626; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .message { max-width: 95%; }
    }
  </style>
</head>
<body>
  <div id="login-screen">
    <div class="login-box">
      <div class="login-avatar">V</div>
      <div class="login-title">Victor</div>
      <div class="login-subtitle">Executive Ally</div>
      <input type="password" id="password-input" class="login-input" placeholder="Enter password" autofocus>
      <button class="login-btn" onclick="authenticate()">Access</button>
    </div>
  </div>
  
  <div id="app-container">
    <nav class="victor-nav">
      <div class="nav-brand">
        <div class="nav-avatar">V</div>
        <span class="nav-title">Victor</span>
      </div>
      <div class="nav-links">
        <a href="index.html" class="nav-link"><span>âŒ‚</span><span>Dashboard</span></a>
        <a href="emails.html" class="nav-link"><span>âœ‰</span><span>Emails</span></a>
        <a href="calendar.html" class="nav-link"><span>ðŸ“…</span><span>Calendar</span></a>
        <a href="tasks.html" class="nav-link"><span>â˜‘</span><span>Tasks</span></a>
        <a href="victor.html" class="nav-link active"><span>ðŸ’¬</span><span>Chat</span></a>
        <a href="victor-dashboard.html" class="nav-link"><span>âš™</span><span>Config</span></a>
      </div>
      <button class="nav-logout" onclick="logout()">Logout</button>
    </nav>
    
    <div class="chat-layout">
      <div class="container">
        <aside class="sidebar">
          <div class="sidebar-header">
            <h2>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <polyline points="9,22 9,12 15,12 15,22"/>
              </svg>
              Victor Chats
            </h2>
            <button class="new-chat-btn" onclick="newSession()" title="New Chat">+</button>
          </div>
          <div class="sessions-list" id="sessions-list"></div>
        </aside>
        
        <main class="main">
          <header class="header">
            <div class="header-left">
              <img src="/failsafe-icon.png" alt="Victor" class="victor-avatar">
              <div class="victor-info">
                <h1>Victor</h1>
                <p>Executive Ally</p>
              </div>
            </div>
            <div style="display: flex; align-items: center;">
              <div class="model-selector">
                <button class="model-btn" onclick="toggleModelDropdown()">
                  <span id="selected-model">GLM-5</span>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 12,15 18,9"/>
                  </svg>
                </button>
                <div class="model-dropdown" id="model-dropdown"></div>
              </div>
              <button class="voice-toggle" id="voice-toggle" onclick="toggleVoice()" title="Toggle Voice">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="11,5 6,9 2,9 2,15 6,15 11,19"/>
                  <path d="M15.54 8.46a5 5 0 010 7.07"/>
                  <path d="M19.07 4.93a10 10 0 010 14.14"/>
                </svg>
              </button>
            </div>
          </header>
          
          <div class="messages" id="messages">
            <div class="empty-state" id="empty-state">
              <img src="/failsafe-icon.png" alt="Victor">
              <p>Start a conversation with Victor</p>
            </div>
          </div>
          
          <div class="input-area">
            <div class="input-wrapper">
              <textarea id="input" placeholder="Message Victor..." rows="1" onkeydown="handleKeydown(event)"></textarea>
              <button id="send-btn" onclick="sendMessage()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22,2 15,22 11,13 2,9"/>
                </svg>
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <script>
    // Auth check
    const PASSWORD = 'AliceGrace';
    const SESSION_KEY = 'victor-auth';
    
    function checkAuth() {
      const auth = sessionStorage.getItem(SESSION_KEY);
      if (auth === 'authenticated') {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        initChat();
      } else {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
      }
    }
    
    function authenticate() {
      const input = document.getElementById('password-input');
      if (input.value === PASSWORD) {
        sessionStorage.setItem(SESSION_KEY, 'authenticated');
        checkAuth();
      } else {
        input.classList.add('shake');
        setTimeout(() => input.classList.remove('shake'), 500);
        input.value = '';
        input.placeholder = 'Incorrect password';
      }
    }
    
    function logout() {
      sessionStorage.removeItem(SESSION_KEY);
      location.reload();
    }
    
    document.getElementById('password-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') authenticate();
    });
    
    // Configuration
    const API_BASE = 'https://qore-runtime-frostwulf.zocomputer.io';
    const API_KEY = 'qore_dev_53864b4213623eaba716687ebcc28e08';
    
    // State
    let sessions = [];
    let activeSessionId = null;
    let models = [];
    let selectedModel = 'openrouter:z-ai/glm-5';
    let voiceEnabled = false;
    let isLoading = false;
    
    // Load sessions from localStorage
    function loadSessions() {
      const saved = localStorage.getItem('victor-sessions');
      if (saved) {
        sessions = JSON.parse(saved);
        if (sessions.length > 0) {
          activeSessionId = sessions[0].id;
        }
      }
      renderSessions();
      renderMessages();
    }
    
    // Save sessions
    function saveSessions() {
      localStorage.setItem('victor-sessions', JSON.stringify(sessions));
    }
    
    // New session
    function newSession() {
      const session = {
        id: 'session-' + Date.now(),
        title: 'New Chat',
        messages: [],
        createdAt: Date.now()
      };
      sessions.unshift(session);
      activeSessionId = session.id;
      saveSessions();
      renderSessions();
      renderMessages();
    }
    
    // Select session
    function selectSession(id) {
      activeSessionId = id;
      renderSessions();
      renderMessages();
    }
    
    // Render sessions
    function renderSessions() {
      const list = document.getElementById('sessions-list');
      list.innerHTML = sessions.map(s => `
        <div class="session-item ${s.id === activeSessionId ? 'active' : ''}" onclick="selectSession('${s.id}')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
          </svg>
          ${s.title}
        </div>
      `).join('');
    }
    
    // Get active session
    function getActiveSession() {
      return sessions.find(s => s.id === activeSessionId);
    }
    
    // Render messages
    function renderMessages() {
      const container = document.getElementById('messages');
      const session = getActiveSession();
      const emptyState = document.getElementById('empty-state');
      
      if (!session || session.messages.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <img src="/failsafe-icon.png" alt="Victor">
            <p>Start a conversation with Victor</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = session.messages.map(m => `
        <div class="message ${m.role}">
          ${m.role === 'assistant' 
            ? '<img src="/failsafe-icon.png" alt="Victor" class="message-avatar">'
            : '<div class="message-avatar">K</div>'
          }
          <div class="message-content">${escapeHtml(m.content)}</div>
        </div>
      `).join('');
      
      container.scrollTop = container.scrollHeight;
    }
    
    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Send message
    async function sendMessage() {
      const input = document.getElementById('input');
      const message = input.value.trim();
      if (!message || isLoading) return;
      
      // Create session if needed
      if (!activeSessionId) {
        newSession();
      }
      
      const session = getActiveSession();
      if (!session) return;
      
      // Add user message
      session.messages.push({ role: 'user', content: message });
      if (session.title === 'New Chat') {
        session.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
      }
      saveSessions();
      renderSessions();
      renderMessages();
      
      input.value = '';
      setLoading(true);
      
      try {
        const response = await fetch(`${API_BASE}/victor/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-qore-api-key': API_KEY
          },
          body: JSON.stringify({
            message,
            history: session.messages.slice(-10).map(m => ({ role: m.role, content: m.content })),
            model: selectedModel
          })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        session.messages.push({ role: 'assistant', content: data.response });
        saveSessions();
        renderMessages();
        
        // TTS if enabled
        if (voiceEnabled && data.response) {
          playTTS(data.response);
        }
      } catch (err) {
        session.messages.push({ role: 'assistant', content: `Error: ${err.message}` });
        saveSessions();
        renderMessages();
      } finally {
        setLoading(false);
      }
    }
    
    // Set loading state
    function setLoading(loading) {
      isLoading = loading;
      const btn = document.getElementById('send-btn');
      const container = document.getElementById('messages');
      
      if (loading) {
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';
        btn.classList.add('stop-btn');
        btn.onclick = () => { /* Could implement abort */ };
        
        // Add loading indicator
        const session = getActiveSession();
        if (session && session.messages.length > 0) {
          const lastMsg = session.messages[session.messages.length - 1];
          if (lastMsg.role === 'user') {
            container.innerHTML += `
              <div class="message assistant">
                <img src="/failsafe-icon.png" alt="Victor" class="message-avatar">
                <div class="loading"><span></span><span></span><span></span></div>
              </div>
            `;
            container.scrollTop = container.scrollHeight;
          }
        }
      } else {
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/></svg>';
        btn.classList.remove('stop-btn');
        btn.onclick = sendMessage;
      }
    }
    
    // Handle keydown
    function handleKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }
    
    // Load models
    async function loadModels() {
      try {
        const response = await fetch(`${API_BASE}/victor/models`, {
          headers: { 'x-qore-api-key': API_KEY }
        });
        const data = await response.json();
        models = data.models || [];
        renderModels();
      } catch (err) {
        console.error('Failed to load models:', err);
        // Fallback
        models = [
          { id: 'openrouter:z-ai/glm-5', name: 'GLM-5', description: 'Fast and capable' },
          { id: 'openrouter:anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', description: 'High quality' }
        ];
        renderModels();
      }
    }
    
    // Render models
    function renderModels() {
      const dropdown = document.getElementById('model-dropdown');
      dropdown.innerHTML = models.map(m => `
        <div class="model-option ${m.id === selectedModel ? 'selected' : ''}" onclick="selectModel('${m.id}', '${m.name}')">
          ${m.name}
          ${m.description ? `<span>${m.description}</span>` : ''}
        </div>
      `).join('');
    }
    
    // Toggle model dropdown
    function toggleModelDropdown() {
      document.getElementById('model-dropdown').classList.toggle('open');
    }
    
    // Select model
    function selectModel(id, name) {
      selectedModel = id;
      document.getElementById('selected-model').textContent = name;
      document.getElementById('model-dropdown').classList.remove('open');
      renderModels();
    }
    
    // Toggle voice
    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      document.getElementById('voice-toggle').classList.toggle('active', voiceEnabled);
    }
    
    // Play TTS
    async function playTTS(text) {
      try {
        const response = await fetch(`${API_BASE}/victor/tts`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-qore-api-key': API_KEY
          },
          body: JSON.stringify({ text })
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const audio = new Audio(URL.createObjectURL(blob));
          audio.play();
        }
      } catch (err) {
        console.error('TTS error:', err);
      }
    }
    
    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.model-selector')) {
        document.getElementById('model-dropdown').classList.remove('open');
      }
    });
    
    // Auto-resize textarea
    document.getElementById('input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
    
    // Initialize
    function initChat() {
      loadSessions();
      loadModels();
    }
    
    checkAuth();
  </script>
</body>
</html>
